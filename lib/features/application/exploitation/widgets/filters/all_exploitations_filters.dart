import 'package:flutter/material.dart';

import 'package:dropdown_pro/dropdown_item.dart';
import 'package:flutter_bloc/flutter_bloc.dart';

import 'package:getwidget/getwidget.dart';

import '../../../../../core/res/constants.dart';
import '../exploitations_widget/bloc/exploitation_bloc.dart';
import 'annee_muti_filter.dart';
import 'variete_multi_filter.dart';

class ExploitationsFilters extends StatelessWidget {
  const ExploitationsFilters({super.key});

  @override
  Widget build(BuildContext context) {
    final double height = MediaQuery.of(context).size.height;
    final double width = MediaQuery.of(context).size.width;
    final filtterController = TextEditingController();

    List<DropdownItem> itemAnneesList = [];
    String singleSelectedAnneeId = "";
    List<DropdownItem> itemSaisonsList = [];
    String singleSelectedSaisonId = "";
    List<DropdownItem> itemVarietesList = [];
    String singleSelectedVarieteId = "";
    List<DropdownItem> itemProducteursList = [];
    String singleSelectedProducteurId = "";
    final List<String> mutiSelectedProducteursIds = [];

    _onLoginButtonPressed() {
      Constants.compte = filtterController.text;
      BlocProvider.of<ExploitationBloc>(context).add(LoadExploitationEvent(
          compte: Constants.compte,
          listStringVarieteId: const [],
          listStringAnneeId: const [],
          listStringSaisonId: const [],
          opId: Constants.utilisateurObject['op_id'] ?? 0,
          listStringProducteurId: Constants.listStringProducteurId));
    }

    return BlocBuilder<ExploitationBloc, ExploitationState>(
        builder: (context, state) {
      return Column(
        children: [
          Container(
            child: GFAccordion(
                title: 'ACTIONS | FILTRAGE',
                collapsedTitleBackgroundColor: Colors.cyan,
                contentChild: Container(
                    child: Column(
                  children: [
                    TextField(
                      controller: filtterController,
                      onChanged: (value) => _onLoginButtonPressed(),
                      decoration: const InputDecoration(
                          labelText: 'Search', suffixIcon: Icon(Icons.search)),
                    ),
                    const SizedBox(
                      height: 20,
                    ),
                    /*
                    Dropdown.multiSelection(
                        title: "CHOISIR PRODUCTEURS",
                        labelText: "PRODUCTEURS",
                        hintText: "Selection producteurs",
                        list: _itemProducteursList,
                        selectedIds: _mutiSelectedProducteursIds,
                        isAllSelection: true,
                        onMultipleItemListener: (selectedItemList) {
                          for (DropdownItem selectedItem in selectedItemList) {
                            String itemId = selectedItem.id;
                            String itemName = selectedItem.value;
                            ProducteurObject producteurObject =
                                selectedItem.data as ProducteurObject;
                            print(
                                "Item Id: $itemId -- Item Name: $itemName ## Other Details ## Prod_Id: ${producteurObject.id} -- Prod_Prenom: ${producteurObject.prenom}-- Prod_Nom: ${producteurObject.nom}");
                          }
                        }),
                    const SizedBox(
                      height: 20,
                    ),
                    Dropdown.singleSelection(
                        title: "CHOISIR UNE ANNEE",
                        labelText: "ANNEE",
                        hintText: "Selection année",
                        list: _itemAnneesList,
                        selectedId: _singleSelectedAnneeId,
                        onSingleItemListener: (selectedItem) {
                          setState(() {
                            _singleSelectedAnneeId = selectedItem.id;
                            // print(' ---------- _singleSelectedAnneeId --------- ${_singleSelectedAnneeId}');
                            _runFilter(filtterController.text);
                          });
                          String itemId = selectedItem.id;
                          String itemName = selectedItem.value;
                          AnneeObject anneeObject =
                              selectedItem.data as AnneeObject;
                          print(
                              "Item Id: $itemId -- Item Name: $itemName ## Other Details ## Annee Id: ${anneeObject.id} -- Annee valeur: ${anneeObject.valeur}");
                        }),
                    
                    const SizedBox(
                      height: 20,
                    ),
                    BlocBuilder<AllVarietesBloc, AllVarietesState>(
                        builder: (context, stateVariete) {
                      List<DropdownItem> list = [];

                      list.add(DropdownItem(
                          id: '',
                          value: 'Choix Variété',
                          data: VarieteObject(
                            id: 0,
                            name: '',
                            surface_unite: '',
                            quantite_unite: '',
                            rendement_unite: 0,
                            produit_id: 0,
                            produit_name: '',
                            filiere_id: 0,
                            filiere_name: '',
                            familleemplacement_id: 0,
                            familleemplacement_name: '',
                          )));
                      var mesVarietes = stateVariete.varietes;
                      mesVarietes?.forEach((element) {
                        print(element.name);
                        list.add(DropdownItem(
                            id: element.id.toString(),
                            value:
                                element.produit_name.toString().toUpperCase() +
                                    ' | ' +
                                    element.name.toString().toUpperCase(),
                            data: VarieteObject(
                              id: element.id,
                              name: element.name,
                              surface_unite: element.surface_unite,
                              quantite_unite: element.quantite_unite,
                              rendement_unite: element.rendement_unite,
                              produit_id: element.produit_id,
                              produit_name: element.produit_name,
                              filiere_id: element.filiere_id,
                              filiere_name: element.filiere_name,
                              familleemplacement_id:
                                  element.familleemplacement_id,
                              familleemplacement_name:
                                  element.familleemplacement_name,
                            )));
                      });

                      _itemVarietesList = list;

                      return Column(
                        children: [
                          Dropdown.singleSelection(
                              title: "CHOISIR UNE VARIETE",
                              labelText: "VARIETE",
                              hintText: "Selection variété",
                              list: _itemVarietesList,
                              selectedId: _singleSelectedVarieteId,
                              onSingleItemListener: (selectedItem) {
                                Constants.singleSelectedVarieteId =
                                    selectedItem.id;
                                _onLoginButtonPressed();
                                String itemId = selectedItem.id;
                                String itemName = selectedItem.value;
                                VarieteObject varieteObject =
                                    selectedItem.data as VarieteObject;
                                print(
                                    "Item Id: $itemId -- Item Name: $itemName ## Other Details ## Variete Id: ${varieteObject.id} -- Variete name: ${varieteObject.name}");
                              }),
                        ],
                      );
                    }),
                    */
                    const SizedBox(
                      height: 20,
                    ),
                    const VarieteMultiFilter(),
                    const SizedBox(
                      height: 20,
                    ),
                    const AnneeMultiFilter(),
                  ],
                )),
                collapsedIcon: const Icon(Icons.add),
                expandedIcon: const Icon(Icons.minimize)),
          ),
          SizedBox(
            height: height * 0.005,
          ),
        ],
      );
    });
  }
}
